#!/bin/bash
# å¯åŠ¨ Aè‚¡èµ„é‡‘æµå‘æ™ºèƒ½åˆ†æç³»ç»Ÿ (Unified)

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•çš„ç»å¯¹è·¯å¾„
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

echo "========================================="
echo "   Aè‚¡èµ„é‡‘æµå‘æ™ºèƒ½åˆ†æç³»ç»Ÿ v1.1"
echo "========================================="

# 1. è‡ªåŠ¨æ¸…ç†æ—§è¿›ç¨‹ (é˜²æ­¢ç«¯å£å†²çª)
# è¿™è§£å†³äº†"æ²¡åŠæ³•å…³"çš„é—®é¢˜ï¼Œæ¯æ¬¡å¯åŠ¨éƒ½ä¼šå…ˆç¡®ä¿æ—§çš„è¢«å…³æ‰
echo "ğŸ§¹ æ­£åœ¨æ£€æŸ¥å¹¶æ¸…ç†æ—§è¿›ç¨‹..."
pkill -9 -f "streamlit" >/dev/null 2>&1
# åŒé‡ä¿é™©ï¼šæ£€æŸ¥ç«¯å£
if lsof -ti:8501 >/dev/null 2>&1; then
    echo "âš ï¸ ç«¯å£ 8501 å ç”¨ï¼Œæ­£åœ¨é‡Šæ”¾..."
    kill -9 $(lsof -ti:8501) >/dev/null 2>&1
fi
sleep 1

# 2. ç¯å¢ƒæ£€æŸ¥
if [ ! -d "venv" ]; then
    echo "âŒ æœªæ‰¾åˆ°è™šæ‹Ÿç¯å¢ƒ (venv)"
    echo "è¯·å…ˆè¿è¡Œ pip install -r requirements.txt å®‰è£…ä¾èµ–"
    exit 1
fi
source venv/bin/activate

# 3. å¯åŠ¨åº”ç”¨
echo "ğŸš€ æ­£åœ¨å¯åŠ¨ç³»ç»Ÿ..."
echo "ğŸ‘‰ æŒ‰ä¸‹ Ctrl+C æˆ–ç›´æ¥å…³é—­æ­¤çª—å£å³å¯å®Œå…¨é€€å‡ºç¨‹åº"
echo "-----------------------------------------"

# è¿è¡Œç»Ÿä¸€å…¥å£ (åŒ…å«ä¸ªè‚¡åˆ†æå’Œå¸‚åœºçƒ­ç‚¹ï¼Œæ— éœ€é€‰æ‹©)
streamlit run stock_analysis/ui/unified_app.py --server.address=0.0.0.0 --server.port=8501
